<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Smashters">
    <meta name="theme-color" content="#00432e">
    <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png">
    <title>The Smashters - Dumpster Fire Golf Club</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ═══════════════════════════════════════════════════════
           FONTS
           ═══════════════════════════════════════════════════════ */
        @font-face {
            font-family: 'Azalea';
            src: url('assets/fonts/Azalea.otf') format('opentype'),
                 url('assets/fonts/Azalea.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        /* ═══════════════════════════════════════════════════════
           CSS VARIABLES - Masters Inspired Palette
           ═══════════════════════════════════════════════════════ */
        :root {
            --masters-green: #006747;
            --masters-dark: #00432e;
            --masters-darkest: #002a1c;
            --masters-light-green: #1a8a5c;
            --masters-yellow: #FFE234;
            --masters-gold: #C8A951;
            --masters-cream: #F5F1E8;
            --masters-red: #CE1141;
            --masters-white: #FFFFFF;
            --masters-black: #1a1a1a;
            --team-a-color: #CE1141;
            --team-b-color: #004F9E;
            --birdie-color: #CE1141;
            --eagle-color: #C8A951;
            --bogey-color: #006747;
            --card-shadow: 0 2px 8px rgba(0,0,0,0.15);
            --card-shadow-hover: 0 4px 16px rgba(0,0,0,0.2);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease;
        }

        /* ═══════════════════════════════════════════════════════
           BASE STYLES
           ═══════════════════════════════════════════════════════ */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: var(--masters-cream);
            color: var(--masters-black);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        /* Azalea: logo/title only. Clean sans-serif for UI headers (Masters broadcast style) */
        .azalea, .header-titles h1, .splash-title {
            font-family: 'Azalea', 'Georgia', serif;
        }
        h2, h3 {
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
        }

        /* ═══════════════════════════════════════════════════════
           HEADER
           ═══════════════════════════════════════════════════════ */
        .app-header {
            background: linear-gradient(180deg, var(--masters-dark) 0%, var(--masters-green) 100%);
            color: var(--masters-white);
            text-align: center;
            padding: 16px 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,0.3);
        }

        .header-top {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 8px;
            position: relative;
        }

        .header-logo {
            width: 64px;
            height: 64px;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .header-titles { text-align: left; }

        .header-titles h1 {
            font-size: 1.6rem;
            color: var(--masters-yellow);
            letter-spacing: 1.5px;
            line-height: 1.1;
        }

        .header-titles .subtitle {
            font-size: 0.75rem;
            color: var(--masters-white);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            opacity: 0.9;
        }

        /* ═══════════════════════════════════════════════════════
           TAB NAVIGATION
           ═══════════════════════════════════════════════════════ */
        .tab-nav {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            gap: 0;
            border-bottom: 2px solid var(--masters-yellow);
        }
        .tab-nav::-webkit-scrollbar { display: none; }

        .tab-btn {
            flex: 0 0 auto;
            padding: 10px 16px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.75rem;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            cursor: pointer;
            white-space: nowrap;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover { color: rgba(255,255,255,0.9); }

        .tab-btn.active {
            color: var(--masters-yellow);
            border-bottom-color: var(--masters-yellow);
        }

        /* Hamburger button - hidden on desktop */
        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 101;
        }
        .hamburger-btn span {
            display: block;
            width: 24px;
            height: 2px;
            background: var(--masters-white);
            margin: 5px 0;
            transition: var(--transition);
            border-radius: 1px;
        }
        .hamburger-btn.open span:nth-child(1) {
            transform: rotate(45deg) translate(5px, 5px);
        }
        .hamburger-btn.open span:nth-child(2) { opacity: 0; }
        .hamburger-btn.open span:nth-child(3) {
            transform: rotate(-45deg) translate(5px, -5px);
        }

        /* Mobile menu overlay */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 99;
        }
        .mobile-menu-overlay.active { display: block; }

        /* Mobile nav styles */
        @media (max-width: 768px) {
            .hamburger-btn { display: block; }

            .app-header { position: sticky; }

            .header-top {
                justify-content: flex-start;
                padding-right: 48px;
            }

            .header-titles { text-align: center; flex: 1; }

            .tab-nav {
                display: none;
                flex-direction: column;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--masters-dark);
                border-bottom: 3px solid var(--masters-yellow);
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                overflow: visible;
                z-index: 100;
                gap: 0;
            }

            .tab-nav.open { display: flex; }

            .tab-btn {
                padding: 14px 20px;
                font-size: 0.9rem;
                border-bottom: none;
                border-left: 3px solid transparent;
                margin-bottom: 0;
                text-align: left;
            }

            .tab-btn:hover { background: rgba(255,255,255,0.05); }

            .tab-btn.active {
                border-bottom: none;
                border-left-color: var(--masters-yellow);
                background: rgba(255,255,255,0.08);
            }
        }

        /* ═══════════════════════════════════════════════════════
           MAIN CONTENT
           ═══════════════════════════════════════════════════════ */
        .tab-content {
            display: none;
            padding: 16px;
            max-width: 900px;
            margin: 0 auto;
            animation: fadeIn 0.2s ease;
        }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ═══════════════════════════════════════════════════════
           LEADERBOARD - Ryder Cup Broadcast Style
           ═══════════════════════════════════════════════════════ */
        .lb-board {
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--card-shadow);
            margin-bottom: 20px;
        }

        .lb-section-header {
            background: var(--masters-green);
            color: var(--masters-yellow);
            padding: 10px 16px;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.85rem;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Match row - 3 column broadcast layout */
        .lb-match-row {
            display: grid;
            grid-template-columns: 1fr 44px 1fr;
            min-height: 48px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.9rem;
        }
        .lb-match-row:last-child { border-bottom: none; }

        .lb-cell-a, .lb-cell-b {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            color: var(--masters-white);
            background: #e8e4db;
            color: var(--masters-black);
            transition: var(--transition);
        }

        /* Team A cell: score on left, name right-aligned */
        .lb-cell-a {
            justify-content: flex-end;
            text-align: right;
            gap: 10px;
        }

        /* Team B cell: name left-aligned, score on right */
        .lb-cell-b {
            justify-content: flex-start;
            text-align: left;
            gap: 10px;
        }

        .lb-player-name {
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lb-match-score {
            font-weight: bold;
            font-size: 0.8rem;
            white-space: nowrap;
            min-width: fit-content;
        }

        /* Leading team gets their color background */
        .lb-cell-a.leading {
            background: var(--team-a-color);
            color: var(--masters-white);
        }
        .lb-cell-b.leading {
            background: var(--team-b-color);
            color: var(--masters-white);
        }

        /* Tied/halved - both sides neutral */
        .lb-cell-a.tied, .lb-cell-b.tied {
            background: #e8e4db;
            color: var(--masters-black);
        }

        /* Pending - lighter */
        .lb-cell-a.pending, .lb-cell-b.pending {
            background: #f0ece3;
            color: #999;
        }

        /* Center thru column */
        .lb-cell-thru {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #6b6b6b;
            color: var(--masters-white);
            font-size: 0.75rem;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        /* Team totals footer bar */
        .lb-totals-row {
            display: grid;
            grid-template-columns: 1fr 44px 1fr;
            min-height: 52px;
            font-size: 1rem;
        }

        .lb-totals-a, .lb-totals-b {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            font-weight: bold;
            color: var(--masters-white);
            gap: 10px;
        }

        .lb-totals-a {
            background: var(--team-a-color);
            justify-content: flex-end;
            text-align: right;
        }
        .lb-totals-b {
            background: var(--team-b-color);
            justify-content: flex-start;
            text-align: left;
        }

        .lb-total-team-name {
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .lb-total-pts {
            font-size: 1.6rem;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-weight: bold;
            line-height: 1;
        }

        .lb-totals-center {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #4a4a4a;
        }

        .lb-totals-center img {
            width: 36px;
            height: 36px;
            object-fit: contain;
            border-radius: 4px;
        }

        .lb-empty { text-align: center; padding: 60px 20px; color: #999; }
        .lb-empty h3 { color: var(--masters-green); margin-bottom: 8px; font-size: 1.3rem; }

        @media (max-width: 600px) {
            .lb-match-row { grid-template-columns: 1fr 36px 1fr; font-size: 0.8rem; }
            .lb-totals-row { grid-template-columns: 1fr 36px 1fr; }
            .lb-cell-a, .lb-cell-b { padding: 8px 8px; }
            .lb-cell-thru { font-size: 0.65rem; }
            .lb-total-pts { font-size: 1.3rem; }
            .lb-total-team-name { font-size: 0.65rem; }
        }

        /* ═══════════════════════════════════════════════════════
           SCORING
           ═══════════════════════════════════════════════════════ */
        .scoring-match-select { margin-bottom: 16px; }

        .scoring-match-btn {
            display: block;
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 8px;
            background: var(--masters-white);
            border: 2px solid #ddd;
            border-radius: var(--radius);
            text-align: left;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        .scoring-match-btn:hover { border-color: var(--masters-green); }
        .scoring-match-btn.active-match {
            border-color: var(--masters-green);
            background: #f0f8f0;
        }

        .scoring-interface {
            background: var(--masters-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .scoring-header {
            background: var(--masters-green);
            color: var(--masters-white);
            padding: 14px 16px;
            text-align: center;
        }

        .scoring-header .match-label {
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.7rem;
            color: var(--masters-gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .scoring-header .match-status-lg {
            font-size: 1.4rem;
            font-weight: bold;
            margin: 4px 0;
        }

        .scoring-hole-nav {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            background: var(--masters-dark);
            color: var(--masters-white);
            gap: 16px;
        }

        .scoring-hole-nav .hole-info {
            text-align: center;
        }

        .scoring-hole-nav .hole-num {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .scoring-hole-nav .hole-details {
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.7rem;
            color: var(--masters-gold);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .hole-nav-btn {
            background: rgba(255,255,255,0.15);
            border: none;
            color: var(--masters-white);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            font-size: 1.3rem;
            cursor: pointer;
            transition: var(--transition);
            flex-shrink: 0;
        }
        .hole-nav-btn:hover { background: rgba(255,255,255,0.25); }
        .hole-nav-btn:disabled { opacity: 0.3; cursor: default; }

        /* Score entry rows */
        .scoring-team-section {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }

        .scoring-team-label {
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 4px 4px 2px;
        }
        .scoring-team-label.team-a { color: var(--team-a-color); }
        .scoring-team-label.team-b { color: var(--team-b-color); }

        .score-entry-row {
            display: flex;
            align-items: center;
            padding: 6px 4px;
            gap: 8px;
        }

        .score-entry-name {
            flex: 1;
            font-size: 0.9rem;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .score-entry-name .hcp-badge {
            font-size: 0.65rem;
            color: #999;
            display: block;
        }

        .score-entry-controls {
            display: flex;
            align-items: center;
            gap: 0;
            flex-shrink: 0;
        }

        .score-adj-btn {
            width: 48px;
            height: 48px;
            border: 2px solid #ddd;
            background: #f9f9f5;
            font-size: 1.4rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            color: var(--masters-black);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .score-adj-btn:first-child { border-radius: var(--radius) 0 0 var(--radius); }
        .score-adj-btn:last-child { border-radius: 0 var(--radius) var(--radius) 0; }
        .score-adj-btn:hover { background: #eee; }
        .score-adj-btn:active { background: #ddd; }

        .score-value-display {
            width: 52px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: bold;
            border-top: 2px solid #ddd;
            border-bottom: 2px solid #ddd;
            background: var(--masters-white);
            position: relative;
        }

        .score-value-display.birdie { color: var(--birdie-color); }
        .score-value-display.eagle { color: var(--eagle-color); }
        .score-value-display.bogey { color: var(--bogey-color); }
        .score-value-display.double-bogey { color: #666; }
        .score-value-display.no-score { color: #ccc; }

        .score-vs-par {
            position: absolute;
            bottom: 1px;
            right: 3px;
            font-size: 0.5rem;
            font-weight: bold;
        }

        .best-ball-indicator {
            font-size: 0.75rem;
            padding: 4px 8px;
            color: #666;
            font-style: italic;
        }
        .best-ball-indicator strong { color: var(--masters-black); }

        .hole-result-banner {
            text-align: center;
            padding: 10px;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-weight: bold;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .hole-result-banner.team-a-win { background: var(--team-a-color); color: var(--masters-white); }
        .hole-result-banner.team-b-win { background: var(--team-b-color); color: var(--masters-white); }
        .hole-result-banner.hole-halved { background: #f0f0e8; color: #666; }
        .hole-result-banner.hole-pending { background: #f9f9f5; color: #bbb; }

        .scoring-hole-strip {
            display: flex;
            overflow-x: auto;
            padding: 10px 12px;
            gap: 4px;
            background: #fafaf5;
            border-top: 1px solid #eee;
            -webkit-overflow-scrolling: touch;
        }

        .hole-dot {
            flex: 0 0 auto;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: bold;
            border: 2px solid #ddd;
            background: var(--masters-white);
            color: #999;
            cursor: pointer;
            transition: var(--transition);
        }
        .hole-dot.current { border-color: var(--masters-green); background: var(--masters-green); color: var(--masters-white); }
        .hole-dot.team-a-won { border-color: var(--team-a-color); background: var(--team-a-color); color: var(--masters-white); }
        .hole-dot.team-b-won { border-color: var(--team-b-color); background: var(--team-b-color); color: var(--masters-white); }
        .hole-dot.halved-hole { border-color: var(--masters-gold); background: var(--masters-gold); color: var(--masters-white); }

        .scoring-clear-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: none;
            border: none;
            border-top: 1px solid #eee;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.7rem;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .scoring-clear-btn:hover { background: #f5f5f0; color: var(--masters-red); }

        /* ═══════════════════════════════════════════════════════
           MATCHES
           ═══════════════════════════════════════════════════════ */
        .match-day-header {
            background: var(--masters-green);
            color: var(--masters-yellow);
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .match-day-header h3 { font-size: 0.9rem; letter-spacing: 0.5px; }

        .match-setup-card {
            background: var(--masters-white);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 12px;
            overflow: hidden;
        }

        .match-setup-header {
            background: var(--masters-dark);
            color: var(--masters-white);
            padding: 10px 16px;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.75rem;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .match-setup-body {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .match-team-col { flex: 1; }

        .match-team-col label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #999;
            margin-bottom: 4px;
        }

        .match-vs-col { font-size: 0.75rem; color: #999; font-style: italic; }

        /* ═══════════════════════════════════════════════════════
           PLAYERS
           ═══════════════════════════════════════════════════════ */
        .player-card {
            background: var(--masters-white);
            border-radius: var(--radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 10px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
        }
        .player-card:hover { box-shadow: var(--card-shadow-hover); }

        .player-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            color: var(--masters-white);
            flex-shrink: 0;
        }
        .player-avatar.team-a { background: var(--team-a-color); }
        .player-avatar.team-b { background: var(--team-b-color); }
        .player-avatar.no-team { background: #bbb; }

        .player-info { flex: 1; }
        .player-info .player-name { font-weight: bold; font-size: 1rem; }
        .player-info .player-detail { font-size: 0.8rem; color: #777; }

        .player-actions { display: flex; gap: 6px; }

        /* ═══════════════════════════════════════════════════════
           DRAFT
           ═══════════════════════════════════════════════════════ */
        .draft-board {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .draft-team-col {
            background: var(--masters-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .draft-team-header {
            padding: 12px;
            text-align: center;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-weight: bold;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: var(--masters-white);
        }
        .draft-team-header.team-a { background: var(--team-a-color); }
        .draft-team-header.team-b { background: var(--team-b-color); }

        .draft-team-list { padding: 8px; min-height: 100px; }

        .draft-pick-item {
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
            font-size: 0.85rem;
            background: #f5f5f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .draft-pick-item .pick-num { font-size: 0.7rem; color: #999; width: 20px; }

        .draft-pool {
            background: var(--masters-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            overflow: hidden;
        }

        .draft-pool-header {
            background: var(--masters-green);
            color: var(--masters-yellow);
            padding: 12px;
            text-align: center;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .draft-pool-indicator {
            background: var(--masters-dark);
            color: var(--masters-white);
            padding: 10px;
            text-align: center;
            font-size: 0.85rem;
        }
        .draft-pool-indicator .picking-team { font-weight: bold; font-size: 1rem; }

        .draft-pool-list { padding: 8px; }

        .draft-player-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 6px;
            background: #f9f9f5;
            border: 2px solid #eee;
            border-radius: var(--radius);
            text-align: left;
            cursor: pointer;
            font-family: 'Georgia', serif;
            font-size: 0.9rem;
            transition: var(--transition);
        }
        .draft-player-btn:hover { border-color: var(--masters-green); background: #f0f8f0; }
        .draft-player-btn .player-hcp { font-size: 0.75rem; color: #999; }

        /* ═══════════════════════════════════════════════════════
           SETTINGS
           ═══════════════════════════════════════════════════════ */
        .settings-section {
            background: var(--masters-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .settings-section-header {
            background: var(--masters-green);
            color: var(--masters-yellow);
            padding: 12px 16px;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.8rem;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .settings-section-body { padding: 16px; }

        .course-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }
        .course-table th {
            background: var(--masters-dark);
            color: var(--masters-yellow);
            padding: 6px 8px;
            text-align: center;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        .course-table td {
            padding: 5px 4px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .course-table input {
            width: 44px;
            padding: 4px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Georgia', serif;
            font-size: 0.8rem;
        }
        .course-table input:focus { outline: none; border-color: var(--masters-green); }
        .course-table .hole-label { font-weight: bold; color: var(--masters-green); }

        /* ═══════════════════════════════════════════════════════
           FORMS & INPUTS
           ═══════════════════════════════════════════════════════ */
        .form-group { margin-bottom: 14px; }

        .form-group label {
            display: block;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            color: #666;
            margin-bottom: 4px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: var(--radius);
            font-family: 'Georgia', serif;
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--masters-white);
        }
        .form-input:focus { outline: none; border-color: var(--masters-green); }

        select.form-input {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        /* ═══════════════════════════════════════════════════════
           BUTTONS
           ═══════════════════════════════════════════════════════ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        .btn-primary { background: var(--masters-green); color: var(--masters-white); }
        .btn-primary:hover { background: var(--masters-dark); }

        .btn-gold { background: var(--masters-gold); color: var(--masters-darkest); }
        .btn-gold:hover { background: var(--masters-yellow); }

        .btn-danger { background: var(--masters-red); color: var(--masters-white); }
        .btn-danger:hover { opacity: 0.9; }

        .btn-outline { background: transparent; border: 2px solid var(--masters-green); color: var(--masters-green); }
        .btn-outline:hover { background: var(--masters-green); color: var(--masters-white); }

        .btn-sm { padding: 6px 12px; font-size: 0.75rem; }
        .btn-block { display: flex; width: 100%; }
        .btn-icon { width: 32px; height: 32px; padding: 0; border-radius: 50%; font-size: 0.85rem; }

        /* ═══════════════════════════════════════════════════════
           UTILITIES
           ═══════════════════════════════════════════════════════ */
        .section-title {
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            color: var(--masters-green);
            font-size: 1.1rem;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 16px;
        }

        .text-center { text-align: center; }
        .text-muted { color: #999; }
        .text-sm { font-size: 0.8rem; }
        .mb-8 { margin-bottom: 8px; }
        .mb-16 { margin-bottom: 16px; }
        .mt-16 { margin-top: 16px; }

        .empty-state { text-align: center; padding: 40px 20px; color: #999; }
        .empty-state h3 { color: var(--masters-green); margin-bottom: 8px; }
        .empty-state p { font-size: 0.9rem; }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--masters-dark);
            color: var(--masters-white);
            padding: 12px 24px;
            border-radius: var(--radius);
            font-size: 0.85rem;
            z-index: 1000;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--masters-cream);
            border-radius: var(--radius-lg);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: var(--masters-green);
            color: var(--masters-yellow);
            padding: 14px 16px;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 1px;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--masters-white);
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body { padding: 16px; }

        .modal-footer {
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            border-top: 1px solid #ddd;
        }

        /* ═══════════════════════════════════════════════════════
           SPLASH SCREEN
           ═══════════════════════════════════════════════════════ */
        .splash-overlay {
            position: fixed;
            inset: 0;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(160deg, var(--masters-dark) 0%, var(--masters-green) 40%, var(--masters-dark) 100%);
            transition: opacity 0.6s ease;
        }
        .splash-overlay.fade-out { opacity: 0; pointer-events: none; }
        .splash-overlay.hidden { display: none; }

        .splash-logo {
            width: 55%;
            max-width: 300px;
            height: auto;
            filter: brightness(0) invert(1);
            opacity: 0;
            animation: splashFadeIn 1.2s ease-out 0.2s forwards;
        }

        .splash-title {
            font-family: 'Azalea', 'Georgia', serif;
            color: var(--masters-yellow);
            font-size: 2.4rem;
            letter-spacing: 2px;
            margin-top: 20px;
            opacity: 0;
            animation: splashFadeIn 1s ease-out 0.8s forwards;
        }

        .splash-subtitle {
            color: var(--masters-white);
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.85rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin-top: 8px;
            opacity: 0;
            animation: splashFadeIn 1s ease-out 1.2s forwards;
        }

        .splash-year {
            color: var(--masters-gold);
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 1rem;
            font-weight: bold;
            letter-spacing: 2px;
            margin-top: 24px;
            opacity: 0;
            animation: splashFadeIn 1s ease-out 1.5s forwards;
        }

        @keyframes splashFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ═══════════════════════════════════════════════════════
           LIVE SHARING
           ═══════════════════════════════════════════════════════ */
        .live-banner {
            background: var(--masters-red);
            color: var(--masters-white);
            text-align: center;
            padding: 6px 12px;
            font-family: 'Trebuchet MS', 'Helvetica Neue', Arial, sans-serif;
            font-size: 0.7rem;
            font-weight: bold;
            letter-spacing: 0.5px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .live-banner.active { display: flex; }
        .live-dot {
            width: 8px;
            height: 8px;
            background: #fff;
            border-radius: 50%;
            animation: livePulse 1.5s infinite;
            flex-shrink: 0;
        }
        @keyframes livePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .live-banner-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 2px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: 'Georgia', serif;
        }
        .live-banner-btn:hover { background: rgba(255,255,255,0.35); }

        /* Viewer mode: disable score editing */
        .viewer-mode .score-adj-btn { pointer-events: none; opacity: 0.3; }
        .viewer-mode .scoring-clear-btn { display: none; }
        .viewer-mode .btn-danger { display: none; }
        .viewer-mode .match-setup-header .btn { display: none; }
        .viewer-mode .match-day-header .btn { display: none; }
        .viewer-mode .player-actions { display: none; }

        /* Scorer mode: only allow their match */
        .scorer-mode .score-adj-btn.disabled-scorer { pointer-events: none; opacity: 0.3; }
        .scorer-mode .scoring-clear-btn.disabled-scorer { display: none; }

        /* Join live card */
        .join-live-card {
            background: var(--masters-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--card-shadow);
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid var(--masters-green);
        }
        .join-live-card h3 {
            color: var(--masters-green);
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
        .join-live-input {
            width: 100%;
            max-width: 200px;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: var(--radius);
            font-family: 'Georgia', serif;
            font-size: 1.1rem;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }
        .join-live-input:focus { outline: none; border-color: var(--masters-green); }
        .join-live-btns { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }

        /* Match code display */
        .match-code-list { margin-top: 12px; }
        .match-code-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: #f5f5f0;
            border-radius: var(--radius);
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .match-code-value {
            font-family: monospace;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--masters-green);
            letter-spacing: 2px;
            background: var(--masters-white);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        /* ═══════════════════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════════════════ */
        @media (max-width: 600px) {
            .header-titles h1 { font-size: 1.3rem; }
            .lb-team-pts { font-size: 2.2rem; }
            .form-row { grid-template-columns: 1fr; }
            .draft-board { grid-template-columns: 1fr; }
            .score-entry-name { font-size: 0.8rem; }
            .score-adj-btn { width: 44px; height: 44px; font-size: 1.2rem; }
            .score-value-display { width: 48px; height: 44px; font-size: 1.2rem; }
        }

        @media (min-width: 768px) {
            .tab-content { padding: 24px; }
            .header-logo { width: 72px; height: 72px; }
            .header-titles h1 { font-size: 2rem; }
        }
    </style>
</head>
<body>

    <!-- ═══════════════════════════════════════════════════════
         SPLASH SCREEN
         ═══════════════════════════════════════════════════════ -->
    <div class="splash-overlay" id="splashOverlay">
        <img src="assets/images/smashters-logo-green.png" alt="" class="splash-logo">
        <div class="splash-title">The Smashters</div>
        <div class="splash-subtitle">Dumpster Fire Golf Club</div>
        <div class="splash-year" id="splashYear"></div>
    </div>

    <!-- ═══════════════════════════════════════════════════════
         HEADER & NAVIGATION
         ═══════════════════════════════════════════════════════ -->
    <header class="app-header">
        <div class="header-top">
            <img src="assets/images/smashters-logo-green.png" alt="Smashters" class="header-logo">
            <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMobileMenu()">
                <span></span><span></span><span></span>
            </button>
            <div class="header-titles">
                <h1>The Smashters</h1>
                <div class="subtitle">Dumpster Fire Golf Club</div>
            </div>
        </div>
        <nav class="tab-nav" id="tabNav">
            <button class="tab-btn active" data-tab="leaderboard">Leaderboard</button>
            <button class="tab-btn" data-tab="scoring">Scoring</button>
            <button class="tab-btn" data-tab="matches">Matches</button>
            <button class="tab-btn" data-tab="players">Players</button>
            <button class="tab-btn" data-tab="draft">Draft</button>
            <button class="tab-btn" data-tab="settings">Settings</button>
        </nav>
    </header>
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="closeMobileMenu()"></div>

    <!-- Live Banner -->
    <div class="live-banner" id="liveBanner"></div>

    <section class="tab-content active" id="tab-leaderboard"><div id="leaderboard-content"></div></section>
    <section class="tab-content" id="tab-scoring"><div id="scoring-content"></div></section>
    <section class="tab-content" id="tab-matches"><div id="matches-content"></div></section>
    <section class="tab-content" id="tab-players"><div id="players-content"></div></section>
    <section class="tab-content" id="tab-draft"><div id="draft-content"></div></section>
    <section class="tab-content" id="tab-settings"><div id="settings-content"></div></section>

    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modalContainer"></div>
    </div>
    <div class="toast" id="toast"></div>

    <script>
    /* ═══════════════════════════════════════════════════════════
       THE SMASHTERS APP
       Dumpster Fire Golf Club - Ryder Cup Style Event Manager
       ═══════════════════════════════════════════════════════════ */

    // ─────────────────────────────────────────────────────────
    // COURSE DATA
    // ─────────────────────────────────────────────────────────
    const DEFAULT_COURSE_HOLES = [
        { hole: 1,  par: 4, hcp: 15 },
        { hole: 2,  par: 5, hcp: 13 },
        { hole: 3,  par: 3, hcp: 9 },
        { hole: 4,  par: 4, hcp: 1 },
        { hole: 5,  par: 5, hcp: 7 },
        { hole: 6,  par: 4, hcp: 3 },
        { hole: 7,  par: 3, hcp: 17 },
        { hole: 8,  par: 4, hcp: 11 },
        { hole: 9,  par: 4, hcp: 5 },
        { hole: 10, par: 4, hcp: 8 },
        { hole: 11, par: 4, hcp: 2 },
        { hole: 12, par: 3, hcp: 16 },
        { hole: 13, par: 4, hcp: 6 },
        { hole: 14, par: 4, hcp: 10 },
        { hole: 15, par: 5, hcp: 12 },
        { hole: 16, par: 3, hcp: 18 },
        { hole: 17, par: 4, hcp: 4 },
        { hole: 18, par: 5, hcp: 14 },
    ];

    // ─────────────────────────────────────────────────────────
    // STATE
    // ─────────────────────────────────────────────────────────
    const STORAGE_KEY = 'smashters-state';

    const defaultState = () => ({
        config: {
            eventName: 'The Smashters',
            clubName: 'Dumpster Fire Golf Club',
            year: new Date().getFullYear(),
            teamA: { name: 'Team Fire', color: '#CE1141' },
            teamB: { name: 'Team Ice', color: '#004F9E' },
            teamSize: 6,
            courseName: '',
            eventDate: '',
            courseHoles: JSON.parse(JSON.stringify(DEFAULT_COURSE_HOLES)),
            useHandicaps: true,
        },
        players: {},
        draft: {
            status: 'pending',
            captainA: null,
            captainB: null,
            picks: [],
            currentTeam: 'A',
        },
        matches: {},
        ui: {
            activeTab: 'leaderboard',
            activeMatchId: null,
            scoringHole: 1,
        },
    });

    let S = loadState();

    function loadState() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                const parsed = JSON.parse(saved);
                const base = defaultState();
                return {
                    config: { ...base.config, ...parsed.config,
                        teamA: { ...base.config.teamA, ...(parsed.config?.teamA || {}) },
                        teamB: { ...base.config.teamB, ...(parsed.config?.teamB || {}) },
                        courseHoles: parsed.config?.courseHoles || base.config.courseHoles,
                    },
                    players: parsed.players || {},
                    draft: { ...base.draft, ...parsed.draft },
                    matches: parsed.matches || {},
                    ui: { ...base.ui, ...parsed.ui },
                };
            }
        } catch (e) { console.error('Load state error:', e); }
        return defaultState();
    }

    function saveState() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(S)); }
        catch (e) { console.error('Save state error:', e); }
        // Sync to Firebase if live
        if (LiveSync.isAdmin || LiveSync.isScorer) {
            LiveSync.syncToFirebase();
        }
    }

    function genId() {
        return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
    }

    // ─────────────────────────────────────────────────────────
    // TOAST & MODAL
    // ─────────────────────────────────────────────────────────
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    function openModal(title, bodyHtml, footerHtml) {
        const overlay = document.getElementById('modalOverlay');
        document.getElementById('modalContainer').innerHTML = `
            <div class="modal-header">
                <span>${title}</span>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">${bodyHtml}</div>
            ${footerHtml ? `<div class="modal-footer">${footerHtml}</div>` : ''}
        `;
        overlay.classList.add('active');
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('active');
    }

    // ─────────────────────────────────────────────────────────
    // TAB NAVIGATION
    // ─────────────────────────────────────────────────────────
    function switchTab(tabId) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tabId));
        document.querySelectorAll('.tab-content').forEach(s => s.classList.toggle('active', s.id === `tab-${tabId}`));
        S.ui.activeTab = tabId;
        saveState();
        renderTab(tabId);
    }

    document.getElementById('tabNav').addEventListener('click', e => {
        if (e.target.classList.contains('tab-btn')) {
            switchTab(e.target.dataset.tab);
            closeMobileMenu();
        }
    });

    // ─────────────────────────────────────────────────────────
    // MOBILE HAMBURGER MENU
    // ─────────────────────────────────────────────────────────
    function toggleMobileMenu() {
        const nav = document.getElementById('tabNav');
        const btn = document.getElementById('hamburgerBtn');
        const overlay = document.getElementById('mobileMenuOverlay');
        const isOpen = nav.classList.contains('open');
        nav.classList.toggle('open', !isOpen);
        btn.classList.toggle('open', !isOpen);
        overlay.classList.toggle('active', !isOpen);
    }

    function closeMobileMenu() {
        document.getElementById('tabNav').classList.remove('open');
        document.getElementById('hamburgerBtn').classList.remove('open');
        document.getElementById('mobileMenuOverlay').classList.remove('active');
    }

    function renderTab(tabId) {
        const r = { leaderboard: renderLeaderboard, scoring: renderScoring, matches: renderMatches,
            players: renderPlayers, draft: renderDraft, settings: renderSettings };
        if (r[tabId]) r[tabId]();
    }

    // ─────────────────────────────────────────────────────────
    // HELPERS
    // ─────────────────────────────────────────────────────────
    function getPlayer(id) { return S.players[id] || null; }
    function getPlayerName(id) { return S.players[id]?.name || 'Unknown'; }
    function getPlayerHcp(id) { return parseInt(S.players[id]?.handicap) || 0; }
    function getTeamPlayers(team) { return Object.values(S.players).filter(p => p.team === team); }
    function getMatchesByDay(day) { return Object.values(S.matches).filter(m => m.day === day).sort((a, b) => a.order - b.order); }

    function getHoleInfo(holeNum) {
        return S.config.courseHoles[holeNum - 1] || { hole: holeNum, par: 4, hcp: holeNum };
    }

    function formatScore(n) {
        if (n === Math.floor(n)) return n.toString();
        return Math.floor(n) + '\u00BD';
    }

    // ─────────────────────────────────────────────────────────
    // HANDICAP & SCORING LOGIC
    // ─────────────────────────────────────────────────────────
    // Returns how many strokes a player receives on a given hole
    function getStrokesOnHole(playerHcp, holeHcpRank) {
        if (!playerHcp || playerHcp <= 0) return 0;
        const full = Math.floor(playerHcp / 18);
        const extra = playerHcp % 18;
        return full + (holeHcpRank <= extra ? 1 : 0);
    }

    // Get the net score for a player on a hole
    function getNetScore(playerId, holeNum, grossScore) {
        if (grossScore === null || grossScore === undefined) return null;
        if (!S.config.useHandicaps) return grossScore;
        const holeInfo = getHoleInfo(holeNum);
        const strokes = getStrokesOnHole(getPlayerHcp(playerId), holeInfo.hcp);
        return grossScore - strokes;
    }

    // Determine who wins a hole from the match scores
    // Returns 'A', 'B', 'halved', or null (incomplete)
    function getHoleWinner(match, holeNum) {
        const holeScores = match.holes[holeNum];
        if (!holeScores) return null;

        // Get all players and their scores
        const teamAIds = match.teamA;
        const teamBIds = match.teamB;

        // Check if all players have scores entered
        const allPlayers = [...teamAIds, ...teamBIds];
        const allHaveScores = allPlayers.every(id => holeScores[id] !== undefined && holeScores[id] !== null);
        if (!allHaveScores) return null;

        if (match.type === 'fourball') {
            // Best ball: lowest net score from each team
            const teamANets = teamAIds.map(id => getNetScore(id, holeNum, holeScores[id])).filter(s => s !== null);
            const teamBNets = teamBIds.map(id => getNetScore(id, holeNum, holeScores[id])).filter(s => s !== null);
            if (teamANets.length === 0 || teamBNets.length === 0) return null;
            const bestA = Math.min(...teamANets);
            const bestB = Math.min(...teamBNets);
            if (bestA < bestB) return 'A';
            if (bestB < bestA) return 'B';
            return 'halved';
        } else {
            // Singles: direct comparison
            const netA = getNetScore(teamAIds[0], holeNum, holeScores[teamAIds[0]]);
            const netB = getNetScore(teamBIds[0], holeNum, holeScores[teamBIds[0]]);
            if (netA === null || netB === null) return null;
            if (netA < netB) return 'A';
            if (netB < netA) return 'B';
            return 'halved';
        }
    }

    // ─────────────────────────────────────────────────────────
    // MATCH PLAY STATUS
    // ─────────────────────────────────────────────────────────
    function getMatchPlayStatus(match) {
        let score = 0; // positive = A leading
        let holesPlayed = 0;

        for (let h = 1; h <= 18; h++) {
            const winner = getHoleWinner(match, h);
            if (winner === 'A') { score++; holesPlayed++; }
            else if (winner === 'B') { score--; holesPlayed++; }
            else if (winner === 'halved') { holesPlayed++; }
            // null = not played or incomplete, stop counting consecutive
        }

        const holesRemaining = 18 - holesPlayed;
        const lead = Math.abs(score);
        const leader = score > 0 ? 'A' : score < 0 ? 'B' : null;
        const isDormie = lead > 0 && lead === holesRemaining;
        const isWon = lead > holesRemaining && holesPlayed > 0;
        const isFinished = holesPlayed === 18;
        const isComplete = match.status === 'complete' || isWon || isFinished;

        if (isComplete && isWon && holesPlayed < 18) {
            return { leader, text: `${lead} & ${holesRemaining}`, isComplete: true, holesPlayed, score, isDormie: false };
        } else if (isComplete && isFinished) {
            if (score === 0) return { leader: null, text: 'HALVED', isComplete: true, holesPlayed, score, isDormie: false };
            return { leader, text: `${lead} UP`, isComplete: true, holesPlayed, score, isDormie: false };
        } else if (holesPlayed === 0) {
            return { leader: null, text: '-', isComplete: false, holesPlayed: 0, score: 0, isDormie: false };
        } else {
            if (score === 0) return { leader: null, text: 'ALL SQUARE', isComplete: false, holesPlayed, score, isDormie };
            return { leader, text: `${lead} UP`, isComplete: false, holesPlayed, score, isDormie };
        }
    }

    function getMatchPoints(match) {
        const status = getMatchPlayStatus(match);
        if (!status.isComplete) return { A: 0, B: 0, settled: false };
        if (status.text === 'HALVED') return { A: 0.5, B: 0.5, settled: true };
        if (status.leader === 'A') return { A: 1, B: 0, settled: true };
        return { A: 0, B: 1, settled: true };
    }

    function getTeamScores() {
        let a = 0, b = 0;
        Object.values(S.matches).forEach(m => {
            const pts = getMatchPoints(m);
            a += pts.A; b += pts.B;
        });
        return { A: a, B: b };
    }

    // ─────────────────────────────────────────────────────────
    // RENDER: LEADERBOARD
    // ─────────────────────────────────────────────────────────
    function renderLeaderboard() {
        const el = document.getElementById('leaderboard-content');
        const allMatches = Object.values(S.matches);
        let joinHtml = '';

        // Show Join Live card if not already connected
        if (!LiveSync.isAdmin && !LiveSync.isViewer && !LiveSync.isScorer) {
            joinHtml = `
                <div class="join-live-card">
                    <h3>Join Live Event</h3>
                    <input class="join-live-input" id="joinCodeInput" placeholder="CODE" maxlength="6"
                        onkeydown="if(event.key==='Enter'){document.getElementById('joinViewBtn').click();}">
                    <div class="join-live-btns">
                        <button class="btn btn-primary btn-sm" id="joinViewBtn" onclick="handleJoinViewer()">View Leaderboard</button>
                        <button class="btn btn-gold btn-sm" onclick="handleJoinScorer()">Score a Match</button>
                    </div>
                    <p class="text-sm text-muted" style="margin-top:8px;">Enter event code to view, or match code to score.</p>
                </div>`;
        }

        if (allMatches.length === 0 && Object.keys(S.players).length === 0) {
            el.innerHTML = joinHtml + `<div class="lb-empty"><h3>Welcome to The Smashters</h3>
                <p>Add players in the <strong>Players</strong> tab to get started,<br>then set up matches in the <strong>Matches</strong> tab.</p></div>`;
            return;
        }

        const scores = getTeamScores();
        const day1 = getMatchesByDay(1);
        const day2 = getMatchesByDay(2);
        let html = '';

        if (day1.length > 0) {
            html += `<div class="lb-board">`;
            html += `<div class="lb-section-header">Day 1 &mdash; Four Ball</div>`;
            html += day1.map(m => renderLeaderboardMatch(m)).join('');
            html += `</div>`;
        }
        if (day2.length > 0) {
            html += `<div class="lb-board" style="margin-top:16px;">`;
            html += `<div class="lb-section-header">Day 2 &mdash; Singles</div>`;
            html += day2.map(m => renderLeaderboardMatch(m)).join('');
            html += `</div>`;
        }

        // Team totals bar
        html += `
            <div class="lb-board" style="margin-top:16px;">
                <div class="lb-totals-row">
                    <div class="lb-totals-a">
                        <span class="lb-total-team-name">${S.config.teamA.name}</span>
                        <span class="lb-total-pts">${formatScore(scores.A)}</span>
                    </div>
                    <div class="lb-totals-center">
                        <img src="assets/images/smashters-logo-green.png" alt="" style="filter:brightness(0) invert(1);">
                    </div>
                    <div class="lb-totals-b">
                        <span class="lb-total-pts">${formatScore(scores.B)}</span>
                        <span class="lb-total-team-name">${S.config.teamB.name}</span>
                    </div>
                </div>
            </div>`;

        if (allMatches.length === 0) {
            html += `<div class="empty-state mt-16"><p>No matches set up yet. Head to the <strong>Matches</strong> tab to create pairings.</p></div>`;
        }

        el.innerHTML = joinHtml + html;
    }

    function handleJoinViewer() {
        const code = document.getElementById('joinCodeInput')?.value?.trim();
        if (!code) { showToast('Enter an event code'); return; }
        LiveSync.joinAsViewer(code);
    }

    function handleJoinScorer() {
        const code = document.getElementById('joinCodeInput')?.value?.trim();
        if (!code) { showToast('Enter a match code'); return; }
        LiveSync.joinAsScorer(code);
    }

    function renderLeaderboardMatch(match) {
        const status = getMatchPlayStatus(match);
        const teamANames = match.teamA.map(id => getPlayerName(id)).join(' / ');
        const teamBNames = match.teamB.map(id => getPlayerName(id)).join(' / ');
        const isALeading = status.leader === 'A';
        const isBLeading = status.leader === 'B';
        const isTied = status.text === 'ALL SQUARE' || status.text === 'HALVED';
        const isPending = status.holesPlayed === 0;

        // Thru / Final indicator for center column
        const thru = isPending ? '' :
            status.isComplete ? 'F' : status.holesPlayed;

        // Cell state classes
        let cellAClass = 'pending', cellBClass = 'pending';
        if (isPending) {
            cellAClass = 'pending'; cellBClass = 'pending';
        } else if (isTied) {
            cellAClass = 'tied'; cellBClass = 'tied';
        } else if (isALeading) {
            cellAClass = 'leading'; cellBClass = 'tied';
        } else if (isBLeading) {
            cellAClass = 'tied'; cellBClass = 'leading';
        }

        // Score text goes on the leading team's side
        // For tied/halved it shows on both sides
        let scoreA = '', scoreB = '';
        if (isPending) {
            // nothing
        } else if (isTied) {
            const label = status.isComplete ? 'Tied' : 'Tied';
            scoreA = label;
            scoreB = label;
        } else if (isALeading) {
            scoreA = status.text;
        } else if (isBLeading) {
            scoreB = status.text;
        }

        return `
            <div class="lb-match-row">
                <div class="lb-cell-a ${cellAClass}">
                    ${scoreA ? `<span class="lb-match-score">${scoreA}</span>` : ''}
                    <span class="lb-player-name">${teamANames}</span>
                </div>
                <div class="lb-cell-thru">${thru}</div>
                <div class="lb-cell-b ${cellBClass}">
                    <span class="lb-player-name">${teamBNames}</span>
                    ${scoreB ? `<span class="lb-match-score">${scoreB}</span>` : ''}
                </div>
            </div>`;
    }

    // ─────────────────────────────────────────────────────────
    // RENDER: SCORING
    // ─────────────────────────────────────────────────────────
    function renderScoring() {
        const el = document.getElementById('scoring-content');

        if (Object.keys(S.matches).length === 0) {
            el.innerHTML = `<div class="empty-state"><h3>No Matches Yet</h3><p>Set up matches first in the Matches tab.</p></div>`;
            return;
        }

        let html = '<h2 class="section-title">Live Scoring</h2>';

        // In scorer mode, only show their assigned match
        const matchesToShow = LiveSync.isScorer
            ? Object.values(S.matches).filter(m => m.id === LiveSync.scorerMatchId)
            : Object.values(S.matches);

        // Match selector
        html += '<div class="scoring-match-select">';
        matchesToShow.forEach(m => {
            const teamANames = m.teamA.map(id => getPlayerName(id)).join(' / ');
            const teamBNames = m.teamB.map(id => getPlayerName(id)).join(' / ');
            const status = getMatchPlayStatus(m);
            const isActive = S.ui.activeMatchId === m.id;
            const canEdit = LiveSync.canScore(m.id);
            html += `
                <button class="scoring-match-btn ${isActive ? 'active-match' : ''}" onclick="selectScoringMatch('${m.id}')">
                    <strong>${teamANames}</strong> vs <strong>${teamBNames}</strong>
                    <span class="text-muted text-sm" style="float:right;">${!canEdit && !LiveSync.isAdmin ? '(view) ' : ''}${status.text}${status.holesPlayed > 0 ? ' &middot; Thru ' + status.holesPlayed : ''}</span>
                </button>`;
        });
        html += '</div>';

        if (S.ui.activeMatchId && S.matches[S.ui.activeMatchId]) {
            html += renderScoringInterface(S.matches[S.ui.activeMatchId]);
        }

        el.innerHTML = html;
    }

    function renderScoringInterface(match) {
        const status = getMatchPlayStatus(match);
        const hole = S.ui.scoringHole || 1;
        const holeInfo = getHoleInfo(hole);
        const holeScores = match.holes[hole] || {};
        const allPlayers = [...match.teamA, ...match.teamB];
        const holeWinner = getHoleWinner(match, hole);

        let statusText = status.text;
        if (status.leader === 'A') statusText = `${S.config.teamA.name} ${status.text}`;
        else if (status.leader === 'B') statusText = `${S.config.teamB.name} ${status.text}`;

        // Build player score entry rows for Team A
        let teamARows = match.teamA.map(id => renderScoreEntryRow(id, hole, holeScores, holeInfo)).join('');
        let teamBRows = match.teamB.map(id => renderScoreEntryRow(id, hole, holeScores, holeInfo)).join('');

        // Best ball indicators for four-ball
        let bestBallA = '', bestBallB = '';
        if (match.type === 'fourball') {
            const aNets = match.teamA.map(id => {
                const g = holeScores[id];
                return g != null ? { id, net: getNetScore(id, hole, g), gross: g } : null;
            }).filter(Boolean);
            const bNets = match.teamB.map(id => {
                const g = holeScores[id];
                return g != null ? { id, net: getNetScore(id, hole, g), gross: g } : null;
            }).filter(Boolean);

            if (aNets.length > 0) {
                const best = aNets.reduce((a, b) => a.net <= b.net ? a : b);
                bestBallA = `<div class="best-ball-indicator">Best ball: <strong>${best.net}</strong>${S.config.useHandicaps && best.net !== best.gross ? ` (${best.gross} gross)` : ''}</div>`;
            }
            if (bNets.length > 0) {
                const best = bNets.reduce((a, b) => a.net <= b.net ? a : b);
                bestBallB = `<div class="best-ball-indicator">Best ball: <strong>${best.net}</strong>${S.config.useHandicaps && best.net !== best.gross ? ` (${best.gross} gross)` : ''}</div>`;
            }
        }

        // Hole result banner
        let bannerClass = 'hole-pending', bannerText = 'Enter scores';
        if (holeWinner === 'A') {
            bannerClass = 'team-a-win';
            bannerText = `${S.config.teamA.name} wins hole`;
        } else if (holeWinner === 'B') {
            bannerClass = 'team-b-win';
            bannerText = `${S.config.teamB.name} wins hole`;
        } else if (holeWinner === 'halved') {
            bannerClass = 'hole-halved';
            bannerText = 'Hole halved';
        }

        // Hole strip
        let holeStrip = '';
        for (let h = 1; h <= 18; h++) {
            const w = getHoleWinner(match, h);
            let cls = '';
            if (h === hole) cls = 'current';
            else if (w === 'A') cls = 'team-a-won';
            else if (w === 'B') cls = 'team-b-won';
            else if (w === 'halved') cls = 'halved-hole';
            holeStrip += `<div class="hole-dot ${cls}" onclick="jumpToHole(${h})">${h}</div>`;
        }

        return `
            <div class="scoring-interface">
                <div class="scoring-header">
                    <div class="match-label">${match.type === 'fourball' ? 'Four Ball' : 'Singles'} &middot; Day ${match.day}</div>
                    <div class="match-status-lg">${statusText}</div>
                </div>
                <div class="scoring-hole-nav">
                    <button class="hole-nav-btn" onclick="prevHole()" ${hole <= 1 ? 'disabled' : ''}>&larr;</button>
                    <div class="hole-info">
                        <div class="hole-num">Hole ${hole}</div>
                        <div class="hole-details">Par ${holeInfo.par} &middot; HCP ${holeInfo.hcp}</div>
                    </div>
                    <button class="hole-nav-btn" onclick="nextHole()" ${hole >= 18 ? 'disabled' : ''}>&rarr;</button>
                </div>

                <div class="scoring-team-section">
                    <div class="scoring-team-label team-a">${S.config.teamA.name}</div>
                    ${teamARows}
                    ${bestBallA}
                </div>

                <div class="scoring-team-section">
                    <div class="scoring-team-label team-b">${S.config.teamB.name}</div>
                    ${teamBRows}
                    ${bestBallB}
                </div>

                <div class="hole-result-banner ${bannerClass}">${bannerText}</div>

                <div class="scoring-hole-strip">${holeStrip}</div>

                <button class="scoring-clear-btn" onclick="clearHoleScores(${hole})">Clear Hole ${hole} Scores</button>

                ${status.isComplete ? '<div style="padding:12px;text-align:center;color:var(--masters-green);font-weight:bold;">Match Complete &mdash; ' + status.text + '</div>' : ''}
            </div>`;
    }

    function renderScoreEntryRow(playerId, holeNum, holeScores, holeInfo) {
        const player = getPlayer(playerId);
        const name = player?.name || 'Unknown';
        const hcp = getPlayerHcp(playerId);
        const grossScore = holeScores[playerId];
        const hasScore = grossScore !== undefined && grossScore !== null;
        const par = holeInfo.par;

        // Strokes received on this hole
        const strokesReceived = S.config.useHandicaps ? getStrokesOnHole(hcp, holeInfo.hcp) : 0;

        // Score display class
        let scoreClass = 'no-score';
        let vsParText = '';
        if (hasScore) {
            const diff = grossScore - par;
            if (diff <= -2) { scoreClass = 'eagle'; vsParText = diff; }
            else if (diff === -1) { scoreClass = 'birdie'; vsParText = '-1'; }
            else if (diff === 0) { scoreClass = ''; vsParText = 'E'; }
            else if (diff === 1) { scoreClass = 'bogey'; vsParText = '+1'; }
            else { scoreClass = 'double-bogey'; vsParText = '+' + diff; }
        }

        const displayScore = hasScore ? grossScore : '-';
        const strokeDots = strokesReceived > 0 ? ' <span style="color:var(--masters-red);font-size:0.7rem;">' + '\u25CF'.repeat(strokesReceived) + '</span>' : '';

        return `
            <div class="score-entry-row">
                <div class="score-entry-name">
                    ${name}${strokeDots}
                    <span class="hcp-badge">HCP ${hcp}${strokesReceived > 0 ? ' (+' + strokesReceived + ')' : ''}</span>
                </div>
                <div class="score-entry-controls">
                    <button class="score-adj-btn" onclick="adjustScore('${playerId}', ${holeNum}, -1)">&minus;</button>
                    <div class="score-value-display ${scoreClass}">
                        ${displayScore}
                        ${vsParText ? `<span class="score-vs-par">${vsParText}</span>` : ''}
                    </div>
                    <button class="score-adj-btn" onclick="adjustScore('${playerId}', ${holeNum}, 1)">+</button>
                </div>
            </div>`;
    }

    function selectScoringMatch(matchId) {
        S.ui.activeMatchId = matchId;
        S.ui.scoringHole = findNextUnplayedHole(S.matches[matchId]);
        saveState();
        renderScoring();
    }

    function findNextUnplayedHole(match) {
        for (let h = 1; h <= 18; h++) {
            if (!getHoleWinner(match, h)) return h;
        }
        return 18;
    }

    function adjustScore(playerId, holeNum, delta) {
        const match = S.matches[S.ui.activeMatchId];
        if (!match) return;

        // Check permissions
        if (!LiveSync.canScore(S.ui.activeMatchId)) {
            showToast('View only - you cannot edit this match');
            return;
        }

        if (!match.holes[holeNum]) match.holes[holeNum] = {};
        const current = match.holes[holeNum][playerId];
        const par = getHoleInfo(holeNum).par;

        if (current === undefined || current === null) {
            // First tap: set to par, then adjust from there
            match.holes[holeNum][playerId] = par;
        } else {
            const newVal = current + delta;
            if (newVal >= 1 && newVal <= 15) {
                match.holes[holeNum][playerId] = newVal;
            }
        }

        // Update match status
        updateMatchStatus(match);
        saveState();
        renderScoring();
    }

    function clearHoleScores(holeNum) {
        const match = S.matches[S.ui.activeMatchId];
        if (!match) return;
        if (!LiveSync.canScore(S.ui.activeMatchId)) {
            showToast('View only - you cannot edit this match');
            return;
        }
        delete match.holes[holeNum];
        updateMatchStatus(match);
        saveState();
        renderScoring();
    }

    function updateMatchStatus(match) {
        const hasAnyScores = Object.keys(match.holes).length > 0;
        const status = getMatchPlayStatus(match);
        if (status.isComplete) {
            match.status = 'complete';
        } else if (hasAnyScores) {
            match.status = 'active';
        } else {
            match.status = 'pending';
        }
    }

    function prevHole() {
        if (S.ui.scoringHole > 1) { S.ui.scoringHole--; saveState(); renderScoring(); }
    }
    function nextHole() {
        if (S.ui.scoringHole < 18) { S.ui.scoringHole++; saveState(); renderScoring(); }
    }
    function jumpToHole(h) {
        S.ui.scoringHole = h; saveState(); renderScoring();
    }

    // ─────────────────────────────────────────────────────────
    // RENDER: MATCHES
    // ─────────────────────────────────────────────────────────
    function renderMatches() {
        const el = document.getElementById('matches-content');
        const day1 = getMatchesByDay(1);
        const day2 = getMatchesByDay(2);
        const teamAPlayers = getTeamPlayers('A');
        const teamBPlayers = getTeamPlayers('B');

        if (teamAPlayers.length === 0 && teamBPlayers.length === 0) {
            el.innerHTML = `<div class="empty-state"><h3>No Teams Yet</h3><p>Assign players to teams first using the <strong>Players</strong> or <strong>Draft</strong> tab.</p></div>`;
            return;
        }

        let html = '<h2 class="section-title">Match Setup</h2>';

        html += `<div class="match-day-header"><h3>Day 1 &mdash; Four Ball</h3>
            <button class="btn btn-gold btn-sm" onclick="openCreateMatch(1, 'fourball')">+ Add Match</button></div>`;
        if (day1.length === 0) { html += `<div class="empty-state mb-16"><p>No four ball matches yet.</p></div>`; }
        else { html += day1.map(m => renderMatchCard(m)).join(''); }

        html += `<div class="match-day-header" style="margin-top:20px;"><h3>Day 2 &mdash; Singles</h3>
            <button class="btn btn-gold btn-sm" onclick="openCreateMatch(2, 'singles')">+ Add Match</button></div>`;
        if (day2.length === 0) { html += `<div class="empty-state"><p>No singles matches yet.</p></div>`; }
        else { html += day2.map(m => renderMatchCard(m)).join(''); }

        el.innerHTML = html;
    }

    function renderMatchCard(match) {
        const teamANames = match.teamA.map(id => getPlayerName(id)).join(' & ');
        const teamBNames = match.teamB.map(id => getPlayerName(id)).join(' & ');
        const label = match.type === 'fourball' ? 'Four Ball' : 'Singles';

        return `
            <div class="match-setup-card">
                <div class="match-setup-header">
                    <span>Match ${match.order} &middot; ${label}</span>
                    <button class="btn btn-sm" style="background:var(--masters-red);color:#fff;padding:4px 10px;" onclick="deleteMatch('${match.id}')">Remove</button>
                </div>
                <div class="match-setup-body">
                    <div class="match-team-col">
                        <label style="color:${S.config.teamA.color}">${S.config.teamA.name}</label>
                        <strong>${teamANames || 'TBD'}</strong>
                    </div>
                    <div class="match-vs-col">vs</div>
                    <div class="match-team-col" style="text-align:right">
                        <label style="color:${S.config.teamB.color}">${S.config.teamB.name}</label>
                        <strong>${teamBNames || 'TBD'}</strong>
                    </div>
                </div>
            </div>`;
    }

    function openCreateMatch(day, type) {
        const teamAPlayers = getTeamPlayers('A');
        const teamBPlayers = getTeamPlayers('B');
        const numPlayers = type === 'fourball' ? 2 : 1;
        const label = type === 'fourball' ? 'Four Ball' : 'Singles';

        let body = `<p class="mb-16">Create a Day ${day} ${label} match.</p>`;
        body += `<div class="form-group"><label style="color:${S.config.teamA.color}">${S.config.teamA.name} Player${numPlayers > 1 ? 's' : ''}</label>`;
        for (let i = 0; i < numPlayers; i++) {
            body += `<select class="form-input mb-8" id="matchTeamA${i}"><option value="">-- Select Player --</option>
                ${teamAPlayers.map(p => `<option value="${p.id}">${p.name} (HCP ${p.handicap || 'N/A'})</option>`).join('')}</select>`;
        }
        body += '</div>';
        body += `<div class="form-group"><label style="color:${S.config.teamB.color}">${S.config.teamB.name} Player${numPlayers > 1 ? 's' : ''}</label>`;
        for (let i = 0; i < numPlayers; i++) {
            body += `<select class="form-input mb-8" id="matchTeamB${i}"><option value="">-- Select Player --</option>
                ${teamBPlayers.map(p => `<option value="${p.id}">${p.name} (HCP ${p.handicap || 'N/A'})</option>`).join('')}</select>`;
        }
        body += '</div>';

        const footer = `<button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createMatch(${day}, '${type}', ${numPlayers})">Create Match</button>`;
        openModal(`New ${label} Match`, body, footer);
    }

    function createMatch(day, type, numPlayers) {
        const teamA = [], teamB = [];
        for (let i = 0; i < numPlayers; i++) {
            const aVal = document.getElementById(`matchTeamA${i}`).value;
            const bVal = document.getElementById(`matchTeamB${i}`).value;
            if (aVal) teamA.push(aVal);
            if (bVal) teamB.push(bVal);
        }
        if (teamA.length === 0 || teamB.length === 0) { showToast('Please select at least one player per team'); return; }

        const match = {
            id: genId(), type, day,
            order: getMatchesByDay(day).length + 1,
            teamA, teamB, holes: {}, status: 'pending',
        };
        S.matches[match.id] = match;
        saveState(); closeModal(); renderMatches();
        showToast('Match created');
    }

    function deleteMatch(matchId) {
        if (!confirm('Remove this match?')) return;
        delete S.matches[matchId];
        saveState(); renderMatches();
        showToast('Match removed');
    }

    // ─────────────────────────────────────────────────────────
    // RENDER: PLAYERS
    // ─────────────────────────────────────────────────────────
    function renderPlayers() {
        const el = document.getElementById('players-content');
        const allPlayers = Object.values(S.players);

        let html = `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h2 class="section-title" style="margin-bottom:0;">Players</h2>
            <button class="btn btn-primary btn-sm" onclick="openPlayerModal()">+ Add Player</button></div>`;

        if (allPlayers.length === 0) {
            html += `<div class="empty-state"><h3>No Players Yet</h3><p>Add players to get started.</p></div>`;
        } else {
            const teamA = allPlayers.filter(p => p.team === 'A');
            const teamB = allPlayers.filter(p => p.team === 'B');
            const unassigned = allPlayers.filter(p => !p.team);

            if (teamA.length > 0) {
                html += `<div class="text-sm text-muted mb-8" style="color:${S.config.teamA.color};font-weight:bold;text-transform:uppercase;letter-spacing:1px;">${S.config.teamA.name} (${teamA.length})</div>`;
                html += teamA.map(p => renderPlayerCard(p)).join('');
            }
            if (teamB.length > 0) {
                html += `<div class="text-sm text-muted mb-8 mt-16" style="color:${S.config.teamB.color};font-weight:bold;text-transform:uppercase;letter-spacing:1px;">${S.config.teamB.name} (${teamB.length})</div>`;
                html += teamB.map(p => renderPlayerCard(p)).join('');
            }
            if (unassigned.length > 0) {
                html += `<div class="text-sm text-muted mb-8 mt-16" style="font-weight:bold;text-transform:uppercase;letter-spacing:1px;">Unassigned (${unassigned.length})</div>`;
                html += unassigned.map(p => renderPlayerCard(p)).join('');
            }
        }
        el.innerHTML = html;
    }

    function renderPlayerCard(player) {
        const initials = player.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        const teamClass = player.team === 'A' ? 'team-a' : player.team === 'B' ? 'team-b' : 'no-team';
        const details = [];
        if (player.handicap) details.push(`HCP: ${player.handicap}`);
        if (player.email) details.push(player.email);
        if (player.phone) details.push(player.phone);

        return `
            <div class="player-card">
                <div class="player-avatar ${teamClass}">${initials}</div>
                <div class="player-info">
                    <div class="player-name">${player.name}</div>
                    <div class="player-detail">${details.join(' &middot; ') || 'No details'}</div>
                </div>
                <div class="player-actions">
                    <button class="btn btn-outline btn-icon btn-sm" onclick="openPlayerModal('${player.id}')" title="Edit">&#9998;</button>
                    <button class="btn btn-danger btn-icon btn-sm" onclick="deletePlayer('${player.id}')" title="Delete">&times;</button>
                </div>
            </div>`;
    }

    function openPlayerModal(playerId) {
        const player = playerId ? S.players[playerId] : null;
        const title = player ? 'Edit Player' : 'Add Player';
        const body = `
            <div class="form-group"><label>Name</label>
                <input class="form-input" id="playerName" value="${player?.name || ''}" placeholder="John Smith"></div>
            <div class="form-row">
                <div class="form-group"><label>Handicap</label>
                    <input class="form-input" id="playerHcp" type="number" value="${player?.handicap || ''}" placeholder="e.g. 12"></div>
                <div class="form-group"><label>Team</label>
                    <select class="form-input" id="playerTeam">
                        <option value="" ${!player?.team ? 'selected' : ''}>Unassigned</option>
                        <option value="A" ${player?.team === 'A' ? 'selected' : ''}>${S.config.teamA.name}</option>
                        <option value="B" ${player?.team === 'B' ? 'selected' : ''}>${S.config.teamB.name}</option>
                    </select></div>
            </div>
            <div class="form-group"><label>Email</label>
                <input class="form-input" id="playerEmail" type="email" value="${player?.email || ''}" placeholder="john@email.com"></div>
            <div class="form-group"><label>Phone</label>
                <input class="form-input" id="playerPhone" type="tel" value="${player?.phone || ''}" placeholder="(555) 123-4567"></div>`;
        const footer = `<button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePlayer('${playerId || ''}')">${player ? 'Save Changes' : 'Add Player'}</button>`;
        openModal(title, body, footer);
        setTimeout(() => document.getElementById('playerName')?.focus(), 100);
    }

    function savePlayer(existingId) {
        const name = document.getElementById('playerName').value.trim();
        if (!name) { showToast('Name is required'); return; }
        const id = existingId || genId();
        S.players[id] = {
            id, name,
            handicap: document.getElementById('playerHcp').value || '',
            team: document.getElementById('playerTeam').value || null,
            email: document.getElementById('playerEmail').value.trim(),
            phone: document.getElementById('playerPhone').value.trim(),
        };
        saveState(); closeModal(); renderPlayers();
        showToast(existingId ? 'Player updated' : 'Player added');
    }

    function deletePlayer(playerId) {
        const player = S.players[playerId];
        if (!confirm(`Remove ${player?.name}?`)) return;
        delete S.players[playerId];
        Object.values(S.matches).forEach(m => {
            m.teamA = m.teamA.filter(id => id !== playerId);
            m.teamB = m.teamB.filter(id => id !== playerId);
        });
        S.draft.picks = S.draft.picks.filter(p => p.playerId !== playerId);
        if (S.draft.captainA === playerId) S.draft.captainA = null;
        if (S.draft.captainB === playerId) S.draft.captainB = null;
        saveState(); renderPlayers();
        showToast('Player removed');
    }

    // ─────────────────────────────────────────────────────────
    // RENDER: DRAFT
    // ─────────────────────────────────────────────────────────
    function renderDraft() {
        const el = document.getElementById('draft-content');
        const allPlayers = Object.values(S.players);

        if (allPlayers.length < 2) {
            el.innerHTML = `<div class="empty-state"><h3>Need More Players</h3><p>Add at least 2 players before starting a draft.</p></div>`;
            return;
        }

        let html = '<h2 class="section-title">Team Draft</h2>';
        if (S.draft.status === 'pending') html += renderDraftSetup();
        else if (S.draft.status === 'active') html += renderDraftActive();
        else html += renderDraftComplete();
        el.innerHTML = html;
    }

    function renderDraftSetup() {
        const allPlayers = Object.values(S.players);
        return `
            <div class="settings-section">
                <div class="settings-section-header">Draft Setup</div>
                <div class="settings-section-body">
                    <p class="mb-16">Snake draft format: Team A picks first, then alternates (A, B, B, A, A, B, ...).</p>
                    <div class="form-row">
                        <div class="form-group"><label>${S.config.teamA.name} Captain</label>
                            <select class="form-input" id="draftCaptainA"><option value="">-- Select --</option>
                                ${allPlayers.map(p => `<option value="${p.id}" ${S.draft.captainA === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select></div>
                        <div class="form-group"><label>${S.config.teamB.name} Captain</label>
                            <select class="form-input" id="draftCaptainB"><option value="">-- Select --</option>
                                ${allPlayers.map(p => `<option value="${p.id}" ${S.draft.captainB === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                            </select></div>
                    </div>
                    <button class="btn btn-primary btn-block mt-16" onclick="startDraft()">Start Draft</button>
                </div>
            </div>`;
    }

    function renderDraftActive() {
        const drafted = new Set(S.draft.picks.map(p => p.playerId));
        if (S.draft.captainA) drafted.add(S.draft.captainA);
        if (S.draft.captainB) drafted.add(S.draft.captainB);
        const available = Object.values(S.players).filter(p => !drafted.has(p.id));
        const teamAPicks = S.draft.picks.filter(p => p.team === 'A');
        const teamBPicks = S.draft.picks.filter(p => p.team === 'B');
        const ct = S.draft.currentTeam;

        let html = `
            <div class="draft-board">
                <div class="draft-team-col">
                    <div class="draft-team-header team-a">${S.config.teamA.name}</div>
                    <div class="draft-team-list">
                        ${S.draft.captainA ? `<div class="draft-pick-item"><span class="pick-num">C</span><strong>${getPlayerName(S.draft.captainA)}</strong></div>` : ''}
                        ${teamAPicks.map((p, i) => `<div class="draft-pick-item"><span class="pick-num">${i + 1}</span>${getPlayerName(p.playerId)}</div>`).join('')}
                    </div>
                </div>
                <div class="draft-team-col">
                    <div class="draft-team-header team-b">${S.config.teamB.name}</div>
                    <div class="draft-team-list">
                        ${S.draft.captainB ? `<div class="draft-pick-item"><span class="pick-num">C</span><strong>${getPlayerName(S.draft.captainB)}</strong></div>` : ''}
                        ${teamBPicks.map((p, i) => `<div class="draft-pick-item"><span class="pick-num">${i + 1}</span>${getPlayerName(p.playerId)}</div>`).join('')}
                    </div>
                </div>
            </div>`;

        if (available.length === 0) {
            html += `<div class="text-center mt-16"><p style="font-size:1.1rem;color:var(--masters-green);font-weight:bold;margin-bottom:12px;">Draft Complete!</p>
                <button class="btn btn-primary" onclick="finalizeDraft()">Finalize Teams</button></div>`;
        } else {
            html += `<div class="draft-pool"><div class="draft-pool-header">Available Players</div>
                <div class="draft-pool-indicator"><span class="picking-team" style="color:${ct === 'A' ? S.config.teamA.color : S.config.teamB.color}">
                    ${ct === 'A' ? S.config.teamA.name : S.config.teamB.name} picks</span></div>
                <div class="draft-pool-list">
                    ${available.map(p => `<button class="draft-player-btn" onclick="makeDraftPick('${p.id}')">
                        ${p.name} <span class="player-hcp">${p.handicap ? 'HCP: ' + p.handicap : ''}</span></button>`).join('')}
                </div></div>
                <div class="mt-16" style="display:flex;gap:8px;">
                    <button class="btn btn-outline btn-sm" onclick="undoDraftPick()" ${S.draft.picks.length === 0 ? 'disabled' : ''}>Undo Last Pick</button>
                    <button class="btn btn-danger btn-sm" onclick="resetDraft()">Reset Draft</button>
                </div>`;
        }
        return html;
    }

    function renderDraftComplete() {
        const teamA = getTeamPlayers('A');
        const teamB = getTeamPlayers('B');
        return `
            <div class="draft-board">
                <div class="draft-team-col"><div class="draft-team-header team-a">${S.config.teamA.name}</div>
                    <div class="draft-team-list">${teamA.map(p => `<div class="draft-pick-item">${p.name}</div>`).join('')}</div></div>
                <div class="draft-team-col"><div class="draft-team-header team-b">${S.config.teamB.name}</div>
                    <div class="draft-team-list">${teamB.map(p => `<div class="draft-pick-item">${p.name}</div>`).join('')}</div></div>
            </div>
            <div class="mt-16 text-center"><button class="btn btn-danger btn-sm" onclick="resetDraft()">Reset Draft</button></div>`;
    }

    function startDraft() {
        const captainA = document.getElementById('draftCaptainA').value;
        const captainB = document.getElementById('draftCaptainB').value;
        if (!captainA || !captainB) { showToast('Select both captains'); return; }
        if (captainA === captainB) { showToast('Captains must be different players'); return; }

        Object.values(S.players).forEach(p => p.team = null);
        S.draft = { captainA, captainB, status: 'active', picks: [], currentTeam: 'A' };
        S.players[captainA].team = 'A';
        S.players[captainB].team = 'B';
        saveState(); renderDraft();
        showToast('Draft started! ' + S.config.teamA.name + ' picks first');
    }

    function makeDraftPick(playerId) {
        const team = S.draft.currentTeam;
        S.draft.picks.push({ team, playerId, order: S.draft.picks.length + 1 });
        S.players[playerId].team = team;
        const nextPick = S.draft.picks.length + 1;
        S.draft.currentTeam = (Math.floor((nextPick - 1) / 2) % 2 === 0) ? 'A' : 'B';
        saveState(); renderDraft();
        showToast(`${team === 'A' ? S.config.teamA.name : S.config.teamB.name} selects ${S.players[playerId].name}`);
    }

    function undoDraftPick() {
        if (S.draft.picks.length === 0) return;
        const last = S.draft.picks.pop();
        S.players[last.playerId].team = null;
        S.draft.currentTeam = last.team;
        saveState(); renderDraft();
    }

    function resetDraft() {
        if (!confirm('Reset the entire draft? All team assignments will be cleared.')) return;
        Object.values(S.players).forEach(p => p.team = null);
        S.draft = { status: 'pending', captainA: null, captainB: null, picks: [], currentTeam: 'A' };
        saveState(); renderDraft();
        showToast('Draft reset');
    }

    function finalizeDraft() {
        S.draft.status = 'complete';
        saveState(); renderDraft();
        showToast('Teams finalized!');
    }

    // ─────────────────────────────────────────────────────────
    // RENDER: SETTINGS
    // ─────────────────────────────────────────────────────────
    function renderSettings() {
        const el = document.getElementById('settings-content');
        const ch = S.config.courseHoles;

        // Course hole table rows
        let courseRows = '';
        for (let i = 0; i < 18; i++) {
            const h = ch[i] || { hole: i + 1, par: 4, hcp: i + 1 };
            courseRows += `<tr>
                <td class="hole-label">${h.hole}</td>
                <td><input type="number" id="par_${i}" value="${h.par}" min="3" max="6"></td>
                <td><input type="number" id="hcp_${i}" value="${h.hcp}" min="1" max="18"></td>
            </tr>`;
        }

        el.innerHTML = `
            <h2 class="section-title">Event Settings</h2>

            <div class="settings-section">
                <div class="settings-section-header">Event Info</div>
                <div class="settings-section-body">
                    <div class="form-group"><label>Event Name</label>
                        <input class="form-input" id="cfgEventName" value="${S.config.eventName}"></div>
                    <div class="form-group"><label>Club Name</label>
                        <input class="form-input" id="cfgClubName" value="${S.config.clubName}"></div>
                    <div class="form-row">
                        <div class="form-group"><label>Course</label>
                            <input class="form-input" id="cfgCourse" value="${S.config.courseName}" placeholder="e.g. Augusta National"></div>
                        <div class="form-group"><label>Event Date</label>
                            <input class="form-input" id="cfgDate" type="date" value="${S.config.eventDate}"></div>
                    </div>
                    <div class="form-group"><label>Year</label>
                        <input class="form-input" id="cfgYear" type="number" value="${S.config.year}"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-header">Teams</div>
                <div class="settings-section-body">
                    <div class="form-row">
                        <div class="form-group"><label>Team A Name</label>
                            <input class="form-input" id="cfgTeamAName" value="${S.config.teamA.name}"></div>
                        <div class="form-group"><label>Team A Color</label>
                            <input class="form-input" id="cfgTeamAColor" type="color" value="${S.config.teamA.color}" style="height:42px;padding:4px;"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Team B Name</label>
                            <input class="form-input" id="cfgTeamBName" value="${S.config.teamB.name}"></div>
                        <div class="form-group"><label>Team B Color</label>
                            <input class="form-input" id="cfgTeamBColor" type="color" value="${S.config.teamB.color}" style="height:42px;padding:4px;"></div>
                    </div>
                    <div class="form-group"><label>Players Per Team</label>
                        <input class="form-input" id="cfgTeamSize" type="number" value="${S.config.teamSize}" min="2" max="20"></div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-header">Scoring</div>
                <div class="settings-section-body">
                    <div class="form-group">
                        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
                            <input type="checkbox" id="cfgUseHandicaps" ${S.config.useHandicaps ? 'checked' : ''} style="width:18px;height:18px;">
                            Apply Handicap Strokes
                        </label>
                        <span class="text-sm text-muted">When enabled, players receive strokes based on their handicap and hole difficulty.</span>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-header">Course Setup</div>
                <div class="settings-section-body" style="padding:8px;overflow-x:auto;">
                    <table class="course-table">
                        <thead><tr><th>Hole</th><th>Par</th><th>HCP</th></tr></thead>
                        <tbody>${courseRows}</tbody>
                    </table>
                </div>
            </div>

            <button class="btn btn-primary btn-block" onclick="saveSettings()">Save Settings</button>

            <div class="settings-section" style="margin-top:24px;">
                <div class="settings-section-header">Live Sharing</div>
                <div class="settings-section-body" id="liveSettingsBody">
                    ${renderLiveSettings()}
                </div>
            </div>

            <div class="settings-section" style="margin-top:24px;">
                <div class="settings-section-header" style="background:var(--masters-red);">Danger Zone</div>
                <div class="settings-section-body">
                    <p class="text-sm text-muted mb-16">Reset all event data including players, matches, and scores.</p>
                    <button class="btn btn-danger" onclick="resetAll()">Reset Everything</button>
                </div>
            </div>`;
    }

    function saveSettings() {
        S.config.eventName = document.getElementById('cfgEventName').value.trim() || 'The Smashters';
        S.config.clubName = document.getElementById('cfgClubName').value.trim();
        S.config.courseName = document.getElementById('cfgCourse').value.trim();
        S.config.eventDate = document.getElementById('cfgDate').value;
        S.config.year = parseInt(document.getElementById('cfgYear').value) || new Date().getFullYear();
        S.config.teamA.name = document.getElementById('cfgTeamAName').value.trim() || 'Team A';
        S.config.teamA.color = document.getElementById('cfgTeamAColor').value;
        S.config.teamB.name = document.getElementById('cfgTeamBName').value.trim() || 'Team B';
        S.config.teamB.color = document.getElementById('cfgTeamBColor').value;
        S.config.teamSize = parseInt(document.getElementById('cfgTeamSize').value) || 6;
        S.config.useHandicaps = document.getElementById('cfgUseHandicaps').checked;

        // Save course holes
        for (let i = 0; i < 18; i++) {
            S.config.courseHoles[i] = {
                hole: i + 1,
                par: parseInt(document.getElementById(`par_${i}`).value) || 4,
                hcp: parseInt(document.getElementById(`hcp_${i}`).value) || (i + 1),
            };
        }

        document.documentElement.style.setProperty('--team-a-color', S.config.teamA.color);
        document.documentElement.style.setProperty('--team-b-color', S.config.teamB.color);
        saveState();
        showToast('Settings saved');
        document.querySelector('.header-titles h1').textContent = S.config.eventName;
        document.querySelector('.header-titles .subtitle').textContent = S.config.clubName;
    }

    function renderLiveSettings() {
        if (LiveSync.isAdmin) {
            // Currently live - show status and match codes
            let matchCodeHtml = '<div class="match-code-list">';
            const allMatches = Object.values(S.matches);
            if (allMatches.length === 0) {
                matchCodeHtml += '<p class="text-sm text-muted">No matches created yet.</p>';
            } else {
                allMatches.forEach(m => {
                    const code = LiveSync.matchCodes[m.id] || '----';
                    const teamANames = m.teamA.map(id => getPlayerName(id)).join(' / ');
                    const teamBNames = m.teamB.map(id => getPlayerName(id)).join(' / ');
                    matchCodeHtml += `
                        <div class="match-code-item">
                            <span>${teamANames} vs ${teamBNames}</span>
                            <span class="match-code-value">${code}</span>
                        </div>`;
                });
            }
            matchCodeHtml += '</div>';

            return `
                <div style="text-align:center;margin-bottom:16px;">
                    <p style="color:var(--masters-green);font-weight:bold;font-size:1rem;margin-bottom:4px;">Event is LIVE</p>
                    <p class="text-sm text-muted">Event Code: <strong style="font-size:1.3rem;color:var(--masters-green);letter-spacing:3px;">${LiveSync.eventCode}</strong></p>
                    <p class="text-sm text-muted">Share this code with viewers to watch the leaderboard.</p>
                </div>
                <p style="font-weight:bold;margin-bottom:8px;font-size:0.8rem;text-transform:uppercase;letter-spacing:1px;color:#666;">Match Codes for Scorers</p>
                <p class="text-sm text-muted mb-8">Give each match's code to their designated scorer.</p>
                ${matchCodeHtml}
                <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="btn btn-danger btn-sm" onclick="LiveSync.stopLive().then(() => renderSettings())">Stop Live Event</button>
                    <button class="btn btn-outline btn-sm" onclick="openAdminResetModal()">Reset Scores</button>
                </div>`;
        } else {
            // Not live - show go live controls
            const hasMatches = Object.keys(S.matches).length > 0;
            return `
                <p class="text-sm text-muted mb-16">Go live to share scores in real-time. Scorers enter a match code on their phone to score their assigned match. Everyone else can view the leaderboard live.</p>
                ${!hasMatches ? '<p style="color:var(--masters-red);font-size:0.85rem;margin-bottom:12px;">Create matches first before going live.</p>' : ''}
                <div class="form-group">
                    <label>Admin PIN</label>
                    <input class="form-input" id="adminPinInput" type="text" placeholder="Set a 4-digit PIN" maxlength="6" value="1234" style="max-width:200px;">
                    <span class="text-sm text-muted">Used to reset scores. Remember this!</span>
                </div>
                <button class="btn btn-primary btn-block" onclick="handleGoLive()" ${!hasMatches ? 'disabled style="opacity:0.5;"' : ''}>Go Live</button>`;
        }
    }

    function handleGoLive() {
        const pin = document.getElementById('adminPinInput')?.value?.trim() || '1234';
        if (!pin) { showToast('Set an admin PIN first'); return; }
        LiveSync.goLive(pin).then(success => {
            if (success) renderSettings();
        });
    }

    function openAdminResetModal() {
        const body = `
            <p class="mb-16">Enter your admin PIN to reset all match scores. This will clear scores but keep players and match pairings.</p>
            <div class="form-group">
                <label>Admin PIN</label>
                <input class="form-input" id="resetPinInput" type="text" placeholder="Enter PIN" maxlength="6" style="max-width:200px;">
            </div>`;
        const footer = `
            <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-danger" onclick="handleAdminReset()">Reset All Scores</button>`;
        openModal('Reset Scores', body, footer);
    }

    function handleAdminReset() {
        const pin = document.getElementById('resetPinInput')?.value?.trim();
        if (!pin) { showToast('Enter your admin PIN'); return; }
        LiveSync.adminReset(pin).then(success => {
            if (success) { closeModal(); renderSettings(); }
        });
    }

    function resetAll() {
        if (!confirm('This will delete ALL data - players, matches, scores, everything. Are you sure?')) return;
        if (!confirm('Really? This cannot be undone.')) return;
        localStorage.removeItem(STORAGE_KEY);
        S = defaultState();
        saveState(); renderTab(S.ui.activeTab);
        showToast('All data reset');
    }

    // ─────────────────────────────────────────────────────────
    // FIREBASE & LIVE SYNC
    // ─────────────────────────────────────────────────────────
    const FIREBASE_CONFIG = {
        apiKey: "AIzaSyDZlbkZMkfmFk1CS1i51JQ1NuknlNae0zo",
        authDomain: "bunchbets.firebaseapp.com",
        databaseURL: "https://bunchbets-default-rtdb.firebaseio.com",
        projectId: "bunchbets",
        storageBucket: "bunchbets.firebasestorage.app",
        messagingSenderId: "267555779116",
        appId: "1:267555779116:web:af1e05bacb82f0d4fe5789"
    };

    const LiveSync = {
        db: null,
        eventRef: null,
        eventCode: null,
        matchCodes: {},
        isAdmin: false,
        isScorer: false,
        isViewer: false,
        scorerMatchId: null,
        adminPin: null,
        listeners: [],
        _suppressListener: false,

        init() {
            if (this.db) return true;
            try {
                if (typeof firebase === 'undefined') {
                    console.warn('Firebase SDK not loaded');
                    return false;
                }
                if (!firebase.apps?.length) firebase.initializeApp(FIREBASE_CONFIG);
                this.db = firebase.database();
                return true;
            } catch (e) {
                console.error('Firebase init failed:', e);
                return false;
            }
        },

        generateCode(len) {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < len; i++) code += chars[Math.floor(Math.random() * chars.length)];
            return code;
        },

        // Admin: Go Live
        async goLive(pin) {
            if (!this.init()) { showToast('Firebase not available'); return false; }

            this.eventCode = this.generateCode(5);
            this.adminPin = pin || '1234';
            this.isAdmin = true;
            this.isViewer = false;
            this.isScorer = false;
            this.eventRef = this.db.ref('smashters/' + this.eventCode);

            // Generate match codes
            this.matchCodes = {};
            const codeToMatch = {};
            Object.keys(S.matches).forEach(matchId => {
                const code = this.generateCode(4);
                this.matchCodes[matchId] = code;
                codeToMatch[code] = matchId;
            });

            try {
                await this.eventRef.set({
                    config: S.config,
                    players: S.players,
                    matches: S.matches,
                    matchCodes: codeToMatch,
                    adminPin: this.adminPin,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                });

                // Store match code lookups at top level for scorer access
                const updates = {};
                Object.entries(codeToMatch).forEach(([code, matchId]) => {
                    updates['smashters-codes/' + code] = {
                        eventCode: this.eventCode,
                        matchId: matchId,
                    };
                });
                if (Object.keys(updates).length > 0) {
                    await this.db.ref().update(updates);
                }

                // Save live state locally
                localStorage.setItem('smashters-live', JSON.stringify({
                    eventCode: this.eventCode,
                    adminPin: this.adminPin,
                    matchCodes: this.matchCodes,
                    isAdmin: true,
                }));

                this.updateBanner();
                showToast('Event is LIVE! Code: ' + this.eventCode);
                renderTab(S.ui.activeTab);
                return true;
            } catch (e) {
                console.error('Go live failed:', e);
                showToast('Failed to go live: ' + e.message);
                this.isAdmin = false;
                return false;
            }
        },

        // Sync local state to Firebase
        syncToFirebase() {
            if (!this.eventRef) return;

            if (this.isAdmin) {
                this._suppressListener = true;
                this.eventRef.update({
                    config: S.config,
                    players: S.players,
                    matches: S.matches,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                }).then(() => {
                    setTimeout(() => { this._suppressListener = false; }, 500);
                }).catch(e => {
                    this._suppressListener = false;
                    console.error('Sync failed:', e);
                });
            } else if (this.isScorer && this.scorerMatchId) {
                const match = S.matches[this.scorerMatchId];
                if (match) {
                    this._suppressListener = true;
                    Promise.all([
                        this.eventRef.child('matches/' + this.scorerMatchId).set(match),
                        this.eventRef.child('updatedAt').set(firebase.database.ServerValue.TIMESTAMP),
                    ]).then(() => {
                        setTimeout(() => { this._suppressListener = false; }, 500);
                    }).catch(e => {
                        this._suppressListener = false;
                        console.error('Score sync failed:', e);
                    });
                }
            }
        },

        // Apply remote state to local
        applyState(val) {
            if (!val) return;
            const base = defaultState();
            if (val.config) {
                S.config = {
                    ...base.config, ...val.config,
                    teamA: { ...base.config.teamA, ...(val.config?.teamA || {}) },
                    teamB: { ...base.config.teamB, ...(val.config?.teamB || {}) },
                    courseHoles: val.config?.courseHoles || base.config.courseHoles,
                };
            }
            S.players = val.players || {};
            S.matches = val.matches || {};
            document.documentElement.style.setProperty('--team-a-color', S.config.teamA.color);
            document.documentElement.style.setProperty('--team-b-color', S.config.teamB.color);
            document.querySelector('.header-titles h1').textContent = S.config.eventName;
            document.querySelector('.header-titles .subtitle').textContent = S.config.clubName;
        },

        // Join as viewer (leaderboard only)
        async joinAsViewer(code) {
            if (!this.init()) { showToast('Firebase not available'); return false; }

            code = code.toUpperCase().trim();
            if (!code) { showToast('Enter an event code'); return false; }

            const ref = this.db.ref('smashters/' + code);
            try {
                const snap = await ref.once('value');
                if (!snap.exists()) { showToast('Event not found. Check the code.'); return false; }

                this.eventCode = code;
                this.eventRef = ref;
                this.isViewer = true;
                this.isAdmin = false;
                this.isScorer = false;

                this.applyState(snap.val());

                // Listen for live updates
                const listener = ref.on('value', (s) => {
                    if (this._suppressListener) return;
                    const val = s.val();
                    if (val) {
                        this.applyState(val);
                        renderTab(S.ui.activeTab);
                    }
                });
                this.listeners.push({ ref, event: 'value', callback: listener });

                document.body.classList.add('viewer-mode');
                this.updateBanner();
                switchTab('leaderboard');
                showToast('Connected! Viewing live scores.');
                return true;
            } catch (e) {
                showToast('Connection failed: ' + e.message);
                return false;
            }
        },

        // Join as scorer with match code
        async joinAsScorer(matchCode) {
            if (!this.init()) { showToast('Firebase not available'); return false; }

            matchCode = matchCode.toUpperCase().trim();
            if (!matchCode) { showToast('Enter a match code'); return false; }

            try {
                const codeSnap = await this.db.ref('smashters-codes/' + matchCode).once('value');
                if (!codeSnap.exists()) { showToast('Invalid match code.'); return false; }

                const { eventCode, matchId } = codeSnap.val();
                const ref = this.db.ref('smashters/' + eventCode);
                const snap = await ref.once('value');
                if (!snap.exists()) { showToast('Event not found.'); return false; }

                this.eventCode = eventCode;
                this.eventRef = ref;
                this.isScorer = true;
                this.isAdmin = false;
                this.isViewer = false;
                this.scorerMatchId = matchId;

                this.applyState(snap.val());

                // Listen for updates
                const listener = ref.on('value', (s) => {
                    if (this._suppressListener) return;
                    const val = s.val();
                    if (val) {
                        this.applyState(val);
                        renderTab(S.ui.activeTab);
                    }
                });
                this.listeners.push({ ref, event: 'value', callback: listener });

                S.ui.activeMatchId = matchId;
                if (S.matches[matchId]) {
                    S.ui.scoringHole = findNextUnplayedHole(S.matches[matchId]);
                }

                document.body.classList.add('scorer-mode');
                this.updateBanner();
                switchTab('scoring');

                const match = S.matches[matchId];
                if (match) {
                    const names = [...match.teamA, ...match.teamB].map(id => getPlayerName(id)).join(', ');
                    showToast('Scoring: ' + names);
                }
                return true;
            } catch (e) {
                showToast('Connection failed: ' + e.message);
                return false;
            }
        },

        // Disconnect from live event
        disconnect() {
            this.listeners.forEach(l => l.ref.off(l.event, l.callback));
            this.listeners = [];
            this.eventRef = null;
            this.eventCode = null;
            this.isAdmin = false;
            this.isViewer = false;
            this.isScorer = false;
            this.scorerMatchId = null;
            this.matchCodes = {};
            this.adminPin = null;
            localStorage.removeItem('smashters-live');
            document.body.classList.remove('viewer-mode', 'scorer-mode');
            this.updateBanner();
            showToast('Disconnected');
            S = loadState();
            renderTab(S.ui.activeTab);
        },

        // Admin: Stop the live event and clean up Firebase
        async stopLive() {
            if (!this.isAdmin || !this.eventRef) return;

            try {
                // Clean up match code lookups
                const matchCodeUpdates = {};
                Object.values(this.matchCodes).forEach(code => {
                    matchCodeUpdates['smashters-codes/' + code] = null;
                });
                if (Object.keys(matchCodeUpdates).length > 0) {
                    await this.db.ref().update(matchCodeUpdates);
                }
                await this.eventRef.remove();
            } catch (e) {
                console.error('Cleanup error:', e);
            }

            this.disconnect();
            showToast('Live event stopped');
        },

        // Admin: Reset all scores in the live event
        async adminReset(pin) {
            if (!this.eventRef) { showToast('Not connected'); return false; }

            try {
                const snap = await this.eventRef.child('adminPin').once('value');
                if (snap.val() !== pin) { showToast('Incorrect PIN'); return false; }

                // Reset all match scores
                Object.values(S.matches).forEach(m => {
                    m.holes = {};
                    m.status = 'pending';
                });

                await this.eventRef.update({
                    matches: S.matches,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                });

                saveState();
                renderTab(S.ui.activeTab);
                showToast('All scores have been reset');
                return true;
            } catch (e) {
                showToast('Reset failed: ' + e.message);
                return false;
            }
        },

        // Restore admin session from localStorage
        restoreSession() {
            try {
                const saved = localStorage.getItem('smashters-live');
                if (!saved) return;
                const session = JSON.parse(saved);
                if (session.isAdmin && session.eventCode) {
                    if (!this.init()) return;
                    this.eventCode = session.eventCode;
                    this.adminPin = session.adminPin;
                    this.matchCodes = session.matchCodes || {};
                    this.isAdmin = true;
                    this.eventRef = this.db.ref('smashters/' + this.eventCode);
                    this.updateBanner();
                }
            } catch (e) {
                console.error('Restore session error:', e);
            }
        },

        // Update the banner display
        updateBanner() {
            const banner = document.getElementById('liveBanner');
            if (!banner) return;

            if (this.isAdmin) {
                banner.className = 'live-banner active';
                banner.style.background = '';
                banner.innerHTML = `
                    <span class="live-dot"></span>
                    LIVE &mdash; Event Code: <strong>${this.eventCode}</strong>
                    <button class="live-banner-btn" onclick="LiveSync.stopLive()">Stop</button>`;
            } else if (this.isViewer) {
                banner.className = 'live-banner active';
                banner.style.background = '';
                banner.innerHTML = `
                    <span class="live-dot"></span>
                    LIVE &mdash; Viewing: <strong>${this.eventCode}</strong>
                    <button class="live-banner-btn" onclick="LiveSync.disconnect()">Leave</button>`;
            } else if (this.isScorer) {
                banner.className = 'live-banner active';
                banner.style.background = 'var(--masters-green)';
                const match = S.matches[this.scorerMatchId];
                const label = match
                    ? match.teamA.map(id => getPlayerName(id)).join('/') + ' vs ' + match.teamB.map(id => getPlayerName(id)).join('/')
                    : 'Match';
                banner.innerHTML = `
                    <span class="live-dot"></span>
                    SCORING &mdash; ${label}
                    <button class="live-banner-btn" onclick="LiveSync.disconnect()">Leave</button>`;
            } else {
                banner.className = 'live-banner';
                banner.innerHTML = '';
            }
        },

        // Check if user can edit scores for a given match
        canScore(matchId) {
            if (this.isViewer) return false;
            if (this.isScorer) return this.scorerMatchId === matchId;
            return true; // Admin or local mode
        },
    };

    // ─────────────────────────────────────────────────────────
    // INIT
    // ─────────────────────────────────────────────────────────
    // ─────────────────────────────────────────────────────────
    // SPLASH SCREEN
    // ─────────────────────────────────────────────────────────
    const SPLASH_KEY = 'smashters-splash-date';

    function shouldShowSplash() {
        const today = new Date().toISOString().slice(0, 10);
        const lastShown = localStorage.getItem(SPLASH_KEY);
        return lastShown !== today;
    }

    function showSplash() {
        const splash = document.getElementById('splashOverlay');
        document.getElementById('splashYear').textContent = S.config.year;
        splash.classList.remove('hidden', 'fade-out');

        // Mark as shown today
        localStorage.setItem(SPLASH_KEY, new Date().toISOString().slice(0, 10));

        // Hold for 3 seconds, then fade out
        setTimeout(() => {
            splash.classList.add('fade-out');
            setTimeout(() => splash.classList.add('hidden'), 600);
        }, 3000);
    }

    function hideSplash() {
        const splash = document.getElementById('splashOverlay');
        splash.classList.add('hidden');
    }

    // ─────────────────────────────────────────────────────────
    // INIT
    // ─────────────────────────────────────────────────────────
    function init() {
        document.documentElement.style.setProperty('--team-a-color', S.config.teamA.color);
        document.documentElement.style.setProperty('--team-b-color', S.config.teamB.color);
        document.querySelector('.header-titles h1').textContent = S.config.eventName;
        document.querySelector('.header-titles .subtitle').textContent = S.config.clubName;

        // Restore Firebase admin session if exists
        LiveSync.restoreSession();

        if (shouldShowSplash()) {
            showSplash();
        } else {
            hideSplash();
        }

        switchTab(S.ui.activeTab || 'leaderboard');
    }

    document.getElementById('modalOverlay').addEventListener('click', e => {
        if (e.target === e.currentTarget) closeModal();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    init();
    </script>
</body>
</html>
